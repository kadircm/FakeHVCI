name: Build-Kernel-Driver

on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Kodu Indir
      uses: actions/checkout@v4

    - name: WDK Önbelleğini Kontrol Et
      id: cache-wdk
      uses: actions/cache@v4
      with:
        path: "C:/Program Files (x86)/Windows Kits/10"
        key: wdk-10.0.22000.0

    - name: WDK'yı Yukle (Sadece Cache Yoksa)
      if: steps.cache-wdk.outputs.cache-hit != 'true'
      run: choco install windowsdriverkit11 -y

    - name: MSBuild Kurulumu
      uses: microsoft/setup-msbuild@v2

    - name: Akilli WDK Tespit ve Derleme
      run: |
        # 1. Gercek SDK versiyonunu bul (Sadece rakamla baslayanlari al)
        $WDK_ROOT = "C:\Program Files (x86)\Windows Kits\10\Include"
        $LATEST_SDK = Get-ChildItem -Path $WDK_ROOT | Where-Object { $_.Name -match '^\d' } | Sort-Object Name -Descending | Select-Object -First 1 -ExpandProperty Name
        
        if (-not $LATEST_SDK) { throw "SDK Klasoru bulunamadi! Makinede WDK yuklu mu?" }
        
        $SDK_INC = "C:\Program Files (x86)\Windows Kits\10\Include\$LATEST_SDK"
        $SDK_LIB = "C:\Program Files (x86)\Windows Kits\10\Lib\$LATEST_SDK\km\x64"
        
        Write-Host "Dogru SDK Versiyonu Bulundu: $LATEST_SDK"

        # 2. MSVC yolunu bul
        $MSVC_BASE = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Tools\MSVC"
        $MSVC_VER = Get-ChildItem -Path $MSVC_BASE | Sort-Object Name -Descending | Select-Object -First 1 -ExpandProperty Name
        $MSVC_PATH = "$MSVC_BASE\$MSVC_VER"
        
        # 3. Ortami Hazirla
        $ENV:INCLUDE = "$MSVC_PATH\include;$SDK_INC\km;$SDK_INC\shared;$SDK_INC\um;$SDK_INC\ucrt"
        
        Write-Host "Derleme basliyor..."
        & "$MSVC_PATH\bin\Hostx64\x64\cl.exe" /c /nologo /O2 /D_AMD64_ /D_KERNEL_MODE /GS- /Zc:inline /Fo"driver.obj" driver.cpp
        
        if ($LASTEXITCODE -ne 0) { throw "Derleme hatasi!" }

        Write-Host "Linkleme basliyor..."
        & "$MSVC_PATH\bin\Hostx64\x64\link.exe" /nologo /DRIVER /SUBSYSTEM:NATIVE /ENTRY:DriverEntry /OUT:"FakeHVCI.sys" /LIBPATH:"$SDK_LIB" ntoskrnl.lib hal.lib driver.obj

    - name: Bitmis Dosyayi Yukle
      uses: actions/upload-artifact@v4
      with:
        name: FakeHVCI-Driver
        path: FakeHVCI.sys
